language: php

sudo: false
dist: trusty
os: linux

cache:
  directories:
    - vendor
    - coverage

addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server

stages:
  - prepare
  - test
  - submit

env:
  global:
    - JOB_COUNT=4 # four jobs generate test coverages
  matrix:
    - TEST_TYPE=examples
    - TEST_TYPE=tests
    - TEST_TYPE=eth

matrix:
    include:
        - php: 7.2
          if: type == push AND branch = master AND fork = false
          env:
            - PHPUNIT_CONF=phpunit.xml.dist
            - COVERAGE_FILTER='App\\Tests\\ControllerIndex'
            - COVERAGE_ID=1
        - php: 7.2
          if: type == push AND branch = master AND fork = false
          env:
            - PHPUNIT_CONF=phpunit.xml.dist
            - COVERAGE_FILTER='App\\Tests\\ControllerList'
            - COVERAGE_ID=2
        - php: 7.2
          if: type == push AND branch = master AND fork = false
          env:
            - PHPUNIT_CONF=phpunit.xml.dist
            - COVERAGE_FILTER='App\\Tests\\ControllerUpdate'
            - COVERAGE_ID=3
        - php: 7.2
          if: type == push AND branch = master AND fork = false
          env:
            - PHPUNIT_CONF=phpunit.xml.dist
            - COVERAGE_FILTER='App\\Tests\\ControllerView'
            - COVERAGE_ID=4

    fast_finish: true

cache:
    directories:
        - $HOME/.composer/cache/files

services:
  - mysql

jobs:
  include:
    - stage: prepare
      env: TEST_TYPE=env
      script:
        - ./cc-test-reporter before-build
      after_success:
    - stage: submit
      env: TEST_TYPE=env
      script:
        - true
      after_script:
         - echo "submitted"
#        - aws s3 sync "s3://xxxxx/coverage/$TRAVIS_COMMIT" coverage/ 
#        - ./cc-test-reporter sum-coverage --output - --parts $JOB_COUNT coverage/codeclimate.*.json | ./cc-test-reporter upload-coverage --input -


before_install:
  - |
    if ! [[ $COVERAGE_FILTER ]]; then
      phpenv config-rm xdebug.ini
    fi
  - composer self-update
  - mysql -e 'CREATE DATABASE travis_test;'
  - cp .env.dist .env

install:
  - |
    if [[ $COVERAGE_FILTER ]]; then
      curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
      chmod +x ./cc-test-reporter
    fi
  - sudo apt-get install -y awscli
  - composer install

script:
  - |
    if [[ $COVERAGE_FILTER ]]; then
      phpunit --configuration $PHPUNIT_CONF --coverage-clover clover.xml --filter $COVERAGE_FILTER
    else
      phpunit --configuration $PHPUNIT_CONF
    fi

after_success:
  - echo "finished"
#  - ./cc-test-reporter format-coverage -t coverage.py -o "coverage/codeclimate.$TEST_TYPE.json"
#  - aws s3 sync coverage/ "s3://xxxxxxxxx/coverage/$TRAVIS_COMMIT"

#after_success:
#  - |
#    if [[ $COVERAGE_FILTER ]]; then
#
#      ./cc-test-reporter format-coverage -t clover -o coverage/clover.$COVERAGE_ID.xml clover.xml
#      ./cc-test-reporter sum-coverage coverage/clover.*.xml -o coverage/clover.xml --parts 4 
#
#      if [[ "$TRAVIS_TEST_RESULT" == 0 ]]; then 
#
#        ./cc-test-reporter upload-coverage -i coverage/clover.xml
#        
#      fi
#    fi