language: php

sudo: false
dist: trusty
os: linux

cache:
  directories:
    - vendor
    - coverage

addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server

stages:
  - name: test
    if: type == push AND branch = master AND fork = false
    env:
      - PHPUNIT_CONF=phpunit.xml.dist
      - COVERAGE_ID=1
  - name: tests_with_coverage
    if: type == push AND branch = master AND fork = false
    env:
      - PHPUNIT_CONF=phpunit.xml.dist
      - COVERAGE_ID=2
  - name: submit
    if: type == push AND branch = master AND fork = false
    env:
      - PHPUNIT_CONF=phpunit.xml.dist

env:
  global:
    - JOB_COUNT=2 # four jobs generate test coverages
  matrix:
    - php: 7.1
    - php: 7.2

#matrix:
#    include:
#        - php: 7.2
#          if: type == push AND branch = master AND fork = false
#          env:
#            - PHPUNIT_CONF=phpunit.xml.dist
#            - COVERAGE_FILTER='App\\Tests\\ControllerIndex'
#            - COVERAGE_ID=1
#        - php: 7.2
#          if: type == push AND branch = master AND fork = false
#          env:
#            - PHPUNIT_CONF=phpunit.xml.dist
#            - COVERAGE_FILTER='App\\Tests\\ControllerList'
#            - COVERAGE_ID=2
#        - php: 7.2
#          if: type == push AND branch = master AND fork = false
#          env:
#            - PHPUNIT_CONF=phpunit.xml.dist
#            - COVERAGE_FILTER='App\\Tests\\ControllerUpdate'
#            - COVERAGE_ID=3
#        - php: 7.2
#          if: type == push AND branch = master AND fork = false
#          env:
#            - PHPUNIT_CONF=phpunit.xml.dist
#            - COVERAGE_FILTER='App\\Tests\\ControllerView'
#            - COVERAGE_ID=4
#
#    fast_finish: true

cache:
    directories:
        - $HOME/.composer/cache/files

services:
  - mysql

jobs:
  include:
    - stage: test
      env:
      script:
      after_success:
    - stage: tests_with_coverage
      env:
      script:
      after_success:
    - stage: submit
      env: 
      script:
        - true
      after_script:
         - echo "submitted"
#        - aws s3 sync "s3://xxxxx/coverage/$TRAVIS_COMMIT" coverage/ 
#        - ./cc-test-reporter sum-coverage --output - --parts $JOB_COUNT coverage/codeclimate.*.json | ./cc-test-reporter upload-coverage --input -


before_install:
  - |
    if ! [[ $COVERAGE_FILTER ]]; then
      phpenv config-rm xdebug.ini
    fi
  - composer self-update
  - mysql -e 'CREATE DATABASE travis_test;'
  - cp .env.dist .env

install:
  - sudo apt-get install -y awscli
  - composer install

before_script:
  - |
    if [[ $COVERAGE_FILTER ]]; then
      curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
      chmod +x ./cc-test-reporter
      ./cc-test-reporter before-build
    fi

script:
  - |
    if [[ $COVERAGE_FILTER ]]; then
      phpunit --configuration $PHPUNIT_CONF --coverage-clover clover.xml --filter $COVERAGE_FILTER
    else
      phpunit --configuration $PHPUNIT_CONF
    fi

after_success:
  - echo "finished"
#  - ./cc-test-reporter format-coverage -t coverage.py -o "coverage/codeclimate.$TEST_TYPE.json"
#  - aws s3 sync coverage/ "s3://xxxxxxxxx/coverage/$TRAVIS_COMMIT"

#after_success:
#  - |
#    if [[ $COVERAGE_FILTER ]]; then
#
#      ./cc-test-reporter format-coverage -t clover -o coverage/clover.$COVERAGE_ID.xml clover.xml
#      ./cc-test-reporter sum-coverage coverage/clover.*.xml -o coverage/clover.xml --parts 4 
#
#      if [[ "$TRAVIS_TEST_RESULT" == 0 ]]; then 
#
#        ./cc-test-reporter upload-coverage -i coverage/clover.xml
#        
#      fi
#    fi