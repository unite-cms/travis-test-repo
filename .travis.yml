language: php

sudo: false
dist: trusty
os: linux

cache:
  directories:
    - vendor
    - coverage

addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server

cache:
    directories:
        - $HOME/.composer/cache/files

services:
  - mysql

jobs:
  include:
    - php: 7.1
      if: type == push AND branch = master AND fork = false
      env:
        - TEST = 1
        - PHPUNIT_CONF=phpunit.xml.dist
        - COVERAGE_FILTER='App\\Tests\\ControllerIndex'
        - COVERAGE_ID=1
    - php: 7.2
      if: type == push AND branch = master AND fork = false
      env:
        - TEST = 1
        - PHPUNIT_CONF=phpunit.xml.dist
        - COVERAGE_FILTER='App\\Tests\\ControllerList'
        - COVERAGE_ID=2
    - php: 7.2
      if: type == push AND branch = master AND fork = false
      env:
        - TEST = 1
        - PHPUNIT_CONF=phpunit.xml.dist
        - COVERAGE_FILTER='App\\Tests\\ControllerUpdate'
        - COVERAGE_ID=3
    - php: 7.2
      if: type == push AND branch = master AND fork = false
      env:
        - TEST = 1
        - PHPUNIT_CONF=phpunit.xml.dist
        - COVERAGE_FILTER='App\\Tests\\ControllerView'
        - COVERAGE_ID=4
    - stage: submit
      env:
        - JOB_COUNT_COVERAGE=4 # 4 jobs are generating coverages
      script:
        - true
      after_script:
        - echo "Get all test coverages from s3 bucket, sum coverage and Upload it to Code Climate"
#       - aws s3 sync "s3://xxxxx/coverage/$TRAVIS_COMMIT" coverage/ 
#       - s3cmd sync "s3://xxxxx/coverage/$TRAVIS_COMMIT" coverage/ 
        - ./cc-test-reporter sum-coverage --output - --parts $JOB_COUNT_COVERAGE coverage/clover.*.xml | ./cc-test-reporter upload-coverage --input - 

before_install:
  - |
    if ! [[ $COVERAGE_FILTER ]]; then
      phpenv config-rm xdebug.ini
    fi
    if [[ $TEST ]]; then
      composer self-update
      mysql -e 'CREATE DATABASE travis_test;'
      cp .env.dist .env
    fi

install:
  - |
    sudo apt-get install -y awscli s3cmd
    if [[ $TEST ]]; then
      composer install
    fi

before_script:
  - |
    curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
    chmod +x ./cc-test-reporter
    ./cc-test-reporter before-build

script:
  - |
    if [[ $COVERAGE_FILTER ]]; then
      phpunit --configuration $PHPUNIT_CONF --coverage-clover clover.xml --filter $COVERAGE_FILTER
    else
      phpunit --configuration $PHPUNIT_CONF
    fi

after_success:
  - |
    if [[ $COVERAGE_FILTER ]]; then
      echo "Formatting and uploading Test Results to S3"
      ./cc-test-reporter format-coverage -t clover -o coverage/clover.$COVERAGE_ID.xml clover.xml
    fi
#  - s3cmd sync coverage/ "s3://xxxxx/coverage/$TRAVIS_COMMIT" 
#  - aws s3 sync coverage/ "s3://xxxxxxxxx/coverage/$TRAVIS_COMMIT"
